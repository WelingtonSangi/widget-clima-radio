<!doctype html>
<html lang="pt-BR">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Widget Clima RÃ¡dio</title>
</head>
<body style="margin:0;background:transparent;">
  <div id="rw-box" style="
    width:100%;
    max-width:560px;
    margin:0 auto;
    padding:14px;
    border-radius:18px;
    border:1px solid rgba(255,255,255,.10);
    font-family:Arial,sans-serif;
    background:linear-gradient(180deg,#0b1220,#070b14);
    color:#e5e7eb;
    box-shadow:0 10px 30px rgba(0,0,0,.45);
    box-sizing:border-box;
  ">
    <div style="display:flex;justify-content:space-between;align-items:center;gap:12px;">
      <div style="min-width:0;">
        <div style="font-size:12px;color:#9ca3af">ðŸŽ§ AO VIVO â€¢ Clima do ouvinte</div>
        <div id="rw-city" style="font-weight:900;font-size:16px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">
          Buscando cidadeâ€¦
        </div>
        <div style="display:flex;gap:10px;margin-top:4px;flex-wrap:wrap;">
          <div style="font-size:12px;color:#9ca3af;">ðŸ“… <span id="rw-date">--/--/----</span></div>
          <div style="font-size:12px;color:#9ca3af;">ðŸ•’ <span id="rw-time">--:--:--</span></div>
        </div>
      </div>

      <div style="display:flex;align-items:center;gap:10px;flex-shrink:0;">
        <div id="rw-icon" style="font-size:30px;line-height:1">â›…</div>
        <div style="text-align:right;">
          <div id="rw-temp" style="font-size:32px;font-weight:900;line-height:1">--Â°C</div>
          <div id="rw-desc" style="font-size:12px;color:#9ca3af;margin-top:3px">Carregandoâ€¦</div>
        </div>
      </div>
    </div>

    <div style="
      margin-top:10px;
      padding:10px 12px;
      border-radius:12px;
      border:1px solid rgba(255,255,255,.10);
      background:rgba(255,255,255,.06);
      color:#cbd5e1;
      font-size:12px;
      line-height:1.3;
    ">
      LocalizaÃ§Ã£o aproximada por IP (nÃ£o precisa permissÃ£o).
    </div>

    <div id="rw-err" style="
      display:none;
      margin-top:10px;
      padding:10px 12px;
      border-radius:12px;
      border:1px solid rgba(239,68,68,.35);
      background:rgba(239,68,68,.10);
      color:#fecaca;
      font-size:12px;
      line-height:1.3;
    ">
      NÃ£o consegui buscar cidade/temperatura agora.
    </div>
  </div>

<script>
  const RW_TZ = "America/Sao_Paulo";
  const REFRESH_MIN = 10;

  const elCity = document.getElementById("rw-city");
  const elTemp = document.getElementById("rw-temp");
  const elDesc = document.getElementById("rw-desc");
  const elIcon = document.getElementById("rw-icon");
  const elErr  = document.getElementById("rw-err");
  const elDate = document.getElementById("rw-date");
  const elTime = document.getElementById("rw-time");

  function clock(){
    const d = new Date();
    elTime.textContent = d.toLocaleTimeString("pt-BR",{hour12:false});
    elDate.textContent = d.toLocaleDateString("pt-BR");
  }
  clock(); setInterval(clock, 1000);

  function info(code){
    const rules = [
      {c:[0], i:"â˜€ï¸", t:"CÃ©u limpo"},
      {c:[1,2], i:"ðŸŒ¤ï¸", t:"Poucas nuvens"},
      {c:[3], i:"â˜ï¸", t:"Nublado"},
      {c:[45,48], i:"ðŸŒ«ï¸", t:"Neblina"},
      {c:[51,53,55,56,57], i:"ðŸŒ¦ï¸", t:"Garoa"},
      {c:[61,63,65], i:"ðŸŒ§ï¸", t:"Chuva"},
      {c:[80,81,82], i:"ðŸŒ§ï¸", t:"Pancadas"},
      {c:[71,73,75,77], i:"â„ï¸", t:"Neve"},
      {c:[95,96,99], i:"â›ˆï¸", t:"Trovoadas"}
    ];
    for(const r of rules) if(r.c.includes(code)) return r;
    return {i:"â›…", t:"Tempo"};
  }

  async function getIP(){
    // Se ipapi.co falhar em algum provedor, troque por: https://ipwho.is/
    const j = await fetch("https://ipapi.co/json/", { cache:"no-store" }).then(r=>r.json());
    return { lat:Number(j.latitude), lon:Number(j.longitude), city:j.city, region:j.region };
  }

  async function getWeather(lat, lon){
    const url = `https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&current=temperature_2m,weather_code&timezone=${encodeURIComponent(RW_TZ)}`;
    const j = await fetch(url, { cache:"no-store" }).then(r=>r.json());
    return { temp:j.current.temperature_2m, code:j.current.weather_code };
  }

  async function update(){
    elErr.style.display = "none";
    try{
      elCity.textContent = "Buscando cidadeâ€¦";
      const ip = await getIP();

      elCity.textContent = ip.city ? (ip.city + (ip.region ? " - " + ip.region : "")) : "Brasil";
      if(!Number.isFinite(ip.lat) || !Number.isFinite(ip.lon)) throw new Error("sem lat/lon");

      const w = await getWeather(ip.lat, ip.lon);
      elTemp.textContent = Math.round(w.temp) + "Â°C";
      const x = info(w.code);
      elIcon.textContent = x.i;
      elDesc.textContent = x.t;
    }catch(e){
      elErr.style.display = "block";
      elDesc.textContent = "Falha ao carregar";
      console.log(e);
    }
  }

  update();
  setInterval(update, REFRESH_MIN * 60 * 1000);
</script>
</body>
</html>
